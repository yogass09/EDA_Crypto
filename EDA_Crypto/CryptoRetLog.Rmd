---
title: "ret_log_sis"
author: "yogesh sahu"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r Libraries}
library(ggplot2)  # for visualization
library(dplyr)    # for data manipulation
library(tidyr)    # for data tidying
library(lubridate)  # for date manipulation
```

```{r datafile, include=FALSE}
#Loaded Data 
library(readr)
df<- read_csv("~/GitHub/EDA_Crypto/DATA/crypto_hist.csv")
```

```{r dropping 0 close prices}
# Subset df_selected to exclude rows where 'close' equals 0
df <- df[df$close > 0.02, ]

# Check the structure or a summary of the updated data frame
str(df)
```


```{r load key}
library(readxl)
key <- read_excel("~/GitHub/CryptoDataFetcher/CryptoDataFetcher2.0/DATA/Keys/MasterDataKey.xlsx")
```

```{r merge key for future ref}
# Merging the 'rank' column from 'key' into 'df' using 'id' as the key
df <- df %>%
  left_join(key %>% select(id, rank), by = "id")
```

```{r test view}
str(df)  # Structure of the dataframe
summary(df)  # Statistical summary of numeric columns
head(df)  # View the first few rows of the dataframe
```

```{r selecting relevant col}
library(dplyr)

# Assuming your dataframe is named df
df_selected <- df %>%
  select(slug, symbol, date, open, close, market_cap, rank)

# Convert 'date' from character to Date format if necessary
df_selected$date <- as.Date(df_selected$date, format = "%d/%m/%Y")

# View the first few rows of the new dataframe to confirm the extraction
print(head(df_selected))
```



```{r Grouped Pct Change}

# Load the dplyr package if not already loaded
library(dplyr)

df_selected <- df_selected %>%
  group_by(symbol) %>%
  mutate(ret = round((close - open) / open, 2))  %>%  # Calculate and round the ret
  ungroup()  # Remove the grouping specification for further general operations


df_selected <- df_selected %>%
  group_by(symbol) %>%
  mutate(
    ret = round((close - open) / open, 2),  # Calculate and round the ret
    # Directly calculate cumulative ret without creating adjusted_ret column
    cum_ret = cumprod(1 + ret) - 1
  ) %>%
  ungroup()  # Remove the grouping specification for further general operations

# Optionally, round cum_ret to 2 decimal places if needed for consistency
df_selected$cum_ret <- round(df_selected$cum_ret, 2)



# Print the updated data frame
print(df_selected)
```






```{r log_ret}
library(dplyr)

# Calculate the logarithmic ret, grouped by symbol if necessary for other analyses
df_selected <- df_selected %>%
  group_by(symbol) %>%
  mutate(log_ret = log(close / open)) %>%  # Calculate log ret as log(close/open)
  ungroup()  # optional: ungroup after the mutation if no further grouped operations

# Assuming df_selected already includes the 'log_ret' calculations
df_selected <- df_selected %>%
  group_by(symbol) %>%
  arrange(date) %>%  # Ensure the data is sorted by date
  mutate(
    cum_log_ret = cumsum(log_ret)  # Calculate cumulative logarithmic ret
  ) %>%
  ungroup()  # Optional: ungroup if no further grouped operations are needed

# Optionally, round cum_ret to 2 decimal places if needed for consistency
df_selected$log_ret <- round(df_selected$log_ret, 2)
# Optionally, round cum_ret to 2 decimal places if needed for consistency
df_selected$cum_log_ret <- round(df_selected$cum_log_ret, 2)

# Print the updated data frame to verify the results
print(df_selected)

```

```{r Check for NA/Inf}
# Check a specific column, e.g., 'log_ret'
sum(is.na(df_selected$log_ret))
sum(is.na(df_selected$ret))
sum(is.infinite(df_selected$log_ret))
```
```{r Drop Na/Inf}
# Remove rows with any NA values from df_selected
df_selected <- na.omit(df_selected)

```


```{r Drop Na/Inf}
CryptoHistRt<-df_selected
```


```{r}
write.csv(df_selected, "Crypto_Hist_LogRt.csv", row.names = FALSE)
```

```{r making new df by transposing log ret and ret}
#for later when we have all the other data pct change as well as log date structureed like MoM or DoD
```



